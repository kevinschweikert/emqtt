# emqtt

![build_packages](https://github.com/emqx/emqtt/actions/workflows/build_packages.yaml/badge.svg)
![run_test_cases](https://github.com/emqx/emqtt/actions/workflows/run_test_case.yaml/badge.svg)

MQTT client library and command line tools implemented in Erlang that supports MQTT v5.0/3.1.1/3.1.

# Getting started

## As a Command Line Tool

### Build

```
$ make
```

Optional, you could disable QUIC support if you have problem with compiling

```sh
BUILD_WITHOUT_QUIC=1 make
```

Once you've compiled successfully you will get a script called `emqtt` in `_build/emqtt/rel/emqtt/bin`. We can see what `emqtt` can do with `--help` option:

```
$ ./emqtt --help
Usage: emqtt pub | sub [--help]
```

`emqtt pub` is used to publish a single message on a topic and exit. `emqtt sub` is used to subscribe to a topic and print the messages that it receives.

### Command-line Syntax

Options can have both short (single character) and long (string) option names.

A short option can have the following syntax:

```
-e arg         Single option 'e', argument "arg"
```

A long option can have the following syntax:

```
--example=arg  Single option 'example', argument "arg"
--example arg  Single option 'example', argument "arg"
```

### Publish

#### Synopsis

```
./emqtt pub [-h [<host>]] [-p <port>] [-I <iface>]
            [-V [<protocol_version>]] [-u <username>]
            [-P <password>] [-C <clientid>] [-k [<keepalive>]]
            [-t <topic>] [-q [<qos>]] [-r [<retain>]]
            [--help <help>] [--will-topic <will_topic>]
            [--will-payload <will_payload>]
            [--will-qos [<will_qos>]]
            [--will-retain [<will_retain>]]
            [--enable-websocket [<enable_websocket>]]
            [--enable-quic [<enable_quic>]]
            [--enable-ssl [<enable_ssl>]]
            [--tls-version [<tls_version>]]
            [--CAfile <cafile>] [--cert <cert>] [--key <key>]
            [--payload <payload>]
            [--file <path/to/file>]
            [--repeat [<repeat>]]
            [--repeat-delay [<repeat_delay>]]
```

#### Options

- **`-h, --host`**: Specify the host to connect to, support for domain name and IP address. Defaults to localhost.
- **`-p, --port`**: Specify the port to connect to. If not given, the default of 1883 for MQTT or 8883 for MQTT over TLS will be used.
- **`-I, --iface`**: Specify the network interface or ip address to use.
- **`-V, --protocol-version`**: Specify the MQTT protocol version used by the client. Can be `v3.1`, `v3.1.1` and `v5`. Defaults to `v5`.
- **`-u, --username`**: Specify the username that can be used by the broker for authentication and authorization.
- **`-P, --password`**: Specify the password for the username.
- **`-C, --clientid`**: Specify the client identifier. If not given, the client identifier in the format `emqtt-<Hostname>-<Random Hexadecimal String>` will be automatically generated by `emqtt_cli`.
- **`-k, --keepalive`**: Specify the interval in seconds sending PINGREQ packets to the broker. Defaults to 300 seconds.
- **`-t, --topic`**: Specify the MQTT topic you want to publish. If the topic beginning with $, you must use single quote(`'`) to specify the topic rather than double quotes(`"`). This is a required option.
- **`-q, --qos`**: Specify the quality of service for the message. Can be 0, 1 and 2. Defaults to 0.
- **`-r, --retain`**: Specify whether the message is a retained message. Defaults to false.
- **`--payload`**: Specify the application message is to be published. This is a required option.
- **`--repeat`**: Specify the number of times the message will be repeatedly published. Defaults to 1.
- **`--repeat-count`**: Specify the number of seconds to wait after the previous message was delivered before publishing the next. Defaults to 0, it means to publish repeated messages as soon as the previous message is sent.
- **`--will-topic`**: Specify the topic of the will message sent when the client disconnects unexpectedly.
- **`--will-qos`**: Specify the quality of service of the will message. Defaults to 0. This must be used in conjunction with `--will-topic`.
- **`--will-retain`**: Specify whether the will message is a retained message. Defaults to false. This must be used in conjunction with `--will-topic`.
- **`--will-payload`**: Specify the application message that will be stored by the broker and sent out if this client disconnects unexpectedly. This must be used in conjunction with `--will-topic`.
- **`--enable-websocket`**: Specify enable WebSocket transport or not. This option can't be used with `--enable-ssl` currently.
- **`--enable-quic`**: Use QUIC as transport. This option can't be combined with `--enable-ssl` or `--enable-websocket`
- **`--enable-ssl`**: Specify enable SSL/TLS transport or not. This option can't be used with `--enable-websocket` currently.
- **`--tls-version`**: Specify which TLS protocol version to use when communicating with the broker. Valid options are tlsv1.3, tlsv1.2, tlsv1.1 and tlsv1. Defaults to tlsv1.2.
- **`--CAfile`**: Specify the path to a file containing PEM encoded CA certificates. This must be used in conjunction with `--enable-ssl`.
- **`--cert`**: Specify the path to a file containing a PEM encoded certificate for this client, if required by the server. This must be used in conjunction with `--enable-ssl`.
- **`--key`**: Specify the path to a file containing a PEM encoded private key for this client, if required by the server. This must be used in conjunction with `--enable-ssl`.

#### Examples

**Publish a simple message over a TCP connection**

```
$ ./emqtt pub -t "hello" --payload "hello world"
Client emqtt-zhouzibodeMacBook-Pro-4623faa14d8256e9cb95 sent CONNECT
Client emqtt-zhouzibodeMacBook-Pro-4623faa14d8256e9cb95 sent PUBLISH (Q0, R0, D0, Topic=hello, Payload=...(11 bytes))
Client emqtt-zhouzibodeMacBook-Pro-4623faa14d8256e9cb95 sent DISCONNECT
```

**Publish a simple message over a TLS connection**

```
$ ./emqtt pub --enable-ssl=true -t "hello" --payload "hello world" --CAfile=certs/cacert.pem --cert=certs/client-cert.pem --key=certs/client-key.pem
Client emqtt-zhouzibodeMacBook-Pro-cec9489c26e3ed7a38eb sent CONNECT
Client emqtt-zhouzibodeMacBook-Pro-cec9489c26e3ed7a38eb sent PUBLISH (Q0, R0, D0, Topic=hello, Payload=...(11 bytes))
Client emqtt-zhouzibodeMacBook-Pro-cec9489c26e3ed7a38eb sent DISCONNECT
```

**Publish a message repeatedly over a WebSocket connection**

```
$ ./emqtt pub --enable-websocket=true -p 8083 -t "hello" --payload "hello world"
Client emqtt-zhouzibodeMacBook-Pro-1e4677ab46cecf1298ac sent CONNECT
Client emqtt-zhouzibodeMacBook-Pro-1e4677ab46cecf1298ac sent PUBLISH (Q0, R0, D0, Topic=hello, Payload=...(11 bytes))
Client emqtt-zhouzibodeMacBook-Pro-1e4677ab46cecf1298ac sent DISCONNECT
```

### Subscribe

#### Synopsis

```
./emqtt sub [-h [<host>]] [-p <port>] [-I <iface>]
            [-V [<protocol_version>]] [-u <username>]
            [-P <password>] [-C <clientid>] [-k [<keepalive>]]
            [-t <topic>] [-q [<qos>]] [--help <help>]
            [--will-topic <will_topic>]
            [--will-payload <will_payload>]
            [--will-qos [<will_qos>]]
            [--will-retain [<will_retain>]]
            [--enable-websocket [<enable_websocket>]]
            [--enable-quic [<enable_quic>]]
            [--enable-ssl [<enable_ssl>]]
            [--tls-version [<tls_version>]]
            [--CAfile <cafile>] [--cert <cert>]
            [--key <key>]
            [--retain-as-publish [<retain_as_publish>]]
            [--retain-handling [<retain_handling>]]
            [--print [size]]
```

#### Options

- **`-h, --host`**: Specify the host to connect to, support for domain name and IP address. Defaults to localhost.
- **`-p, --port`**: Specify the port to connect to. If not given, the default of 1883 for MQTT or 8883 for MQTT over TLS will be used.
- **`-I, --iface`**: Specify the network interface or ip address to use.
- **`-V, --protocol-version`**: Specify the MQTT protocol version used by the client. Can be `v3.1`, `v3.1.1` and `v5`. Defaults to `v5`.
- **`-u, --username`**: Specify the username that can be used by the broker for authentication and authorization.
- **`-P, --password`**: Specify the password for the username.
- **`-C, --clientid`**: Specify the client identifier. If not given, the client identifier in the format `emqtt-<Hostname>-<Random Hexadecimal String>` will be automatically generated by `emqtt_cli`.
- **`-k, --keepalive`**: Specify the interval in seconds sending PINGREQ packets to the broker. Defaults to 300 seconds.
- **`-t, --topic`**: Specify the MQTT topic you want to subscribe to. This is a required option.
- **`-q, --qos`**: Specify the maximum qos level at which the broker can send application messages to the client. Defaults to 0.
- **`--retain-as-publish`**: Specify the Retain As Publish option in subscription options. Defaults to 0.
- **`--retain-handling`**: Specify the Retain Handling option in subscription options. Defaults to 0.
- **`--print`**: Use `size` to print just the number of received payload bytes. Payload is printed as string if this option is not sepcified.
- **`--will-topic`**: Specify the topic of the will message sent when the client disconnects unexpectedly.
- **`--will-qos`**: Specify the quality of service of the will message. Defaults to 0. This must be used in conjunction with `--will-topic`.
- **`--will-retain`**: Specify whether the will message is a retained message. Defaults to false. This must be used in conjunction with `--will-topic`.
- **`--will-payload`**: Specify the application message that will be stored by the broker and sent out if this client disconnects unexpectedly. This must be used in conjunction with `--will-topic`.
- **`--enable-websocket`**: Specify enable WebSocket transport or not. This option can't be used with `--enable-ssl` currently.
- **`--enable-quic`**: Use QUIC as transport. This option can't be combined with `--enable-ssl` or `--enable-websocket`
- **`--enable-ssl`**: Specify enable SSL/TLS transport or not. This option can't be used with `--enable-websocket` currently.
- **`--tls-version`**: Specify which TLS protocol version to use when communicating with the broker. Valid options are tlsv1.3, tlsv1.2, tlsv1.1 and tlsv1. Defaults to tlsv1.2.
- **`--CAfile`**: Specify the path to a file containing PEM encoded CA certificates. This must be used in conjunction with `--enable-ssl`.
- **`--cert`**: Specify the path to a file containing a PEM encoded certificate for this client, if required by the server. This must be used in conjunction with `--enable-ssl`.
- **`--key`**: Specify the path to a file containing a PEM encoded private key for this client, if required by the server. This must be used in conjunction with `--enable-ssl`.

#### Examples

**Build Non-shared Subscription and Recv "hello world"**

```
$ ./emqtt sub -t "hello"
Client emqtt-zhouzibodeMacBook-Pro-1686fee6fdb99f674f2c sent CONNECT
Client emqtt-zhouzibodeMacBook-Pro-1686fee6fdb99f674f2c subscribed to hello
hello world
```

**Build Shared Subscription and Recv "hello world"**

```
$ ./emqtt sub -t '$share/group/hello'
Client emqtt-zhouzibodeMacBook-Pro-288e65bb3f4013d30249 sent CONNECT
Client emqtt-zhouzibodeMacBook-Pro-288e65bb3f4013d30249 subscribed to $share/group/hello
hello world
```

---

## As a Dependency Library

### Add to rebar3 project

Add to `rebar.config`

```erlang
...
{deps, [{emqtt, "1.14.7"}]}.
...
```

### Examples

```
{ok, ConnPid} = emqtt:start_link([{clientid, ClientId}]).
{ok, _Props} = emqtt:connect(ConnPid).

SubOpts = [{qos, 1}].
{ok, _Props, _ReasonCodes} = emqtt:subscribe(ConnPid, #{}, [{<<"hello">>, SubOpts}]).

ok = emqtt:publish(ConnPid, <<"hello">>, #{}, <<"Hello World!">>, [{qos, 0}]).
{ok, _PktId} = emqtt:publish(ConnPid, <<"hello">>, #{}, <<"Hello World!">>, [{qos, 1}]).

receive
    {disconnect, ReasonCode, Properties} ->
        io:format("Recv a DISONNECT packet - ReasonCode: ~p, Properties: ~p~n", [ReasonCode, Properties]);
    {publish, PUBLISH} ->
        io:format("Recv a PUBLISH packet: ~p~n", [PUBLISH]);
    {puback, {PacketId, ReasonCode, Properties}} ->
        io:format("Recv a PUBACK packet - PacketId: ~p, ReasonCode: ~p, Properties: ~p~n", [PacketId, ReasonCode, Properties])
end.

{ok, _Props, _ReasonCode} = emqtt:unsubscribe(ConnPid, #{}, <<"hello">).

ok = emqtt:disconnect(ConnPid).
ok = emqtt:stop(ConnPid).
```

## Enhanced Authentication

As a MQTT client CLI, `emqtt` currently does not support enhanced authentication.

As a MQTT client library, `emqtt` supports enhanced authentication with caller provided
callbacks.

The callbacks should be provided as a `start_link` option `{custom_auth_callbacks, Callbacks}`,
where the `Callbacks` parameter should be a map structured as follows:

```erlang
#{
  init => {InitFunc :: function(), InitArgs :: list()},
  handle_auth => HandleAuth :: function()
}.
```

### InitFunc

This function is executed with InitArgs as arguments. It must return a tuple `{AuthProps, AuthState}`, where:

- `AuthProps` is a map containing the initial authentication properties, including `'Authentication-Method'` and `'Authentication-Data'`.

- `AuthState` is a term that is used in subsequent authentication steps.

### HandleAuth

This function is responsible for handling the continuation of the authentication process. It accepts the following parameters:

- `AuthState`: The current state of authentication.
- `continue_authentication | ErrorCode`: A directive to continue authentication or an error code indicating the failure reason.
- `AuthProps`: A map containing properties for authentication, which must always include `'Authentication-Method'` and `'Authentication-Data'` at each step of the authentication process.

The function should return a tuple in the form of: `{continue, {?RC_CONTINUE_AUTHENTICATION, AuthProps}, AuthState}` or `{stop, Reason}` to abort.

### Examples

For practical implementations of these callbacks, refer to the following test suites in this repository:

- `test/emqtt_scram_auth_SUITE.erl`
- `test/emqtt_kerberos_auth_SUITE.erl`

These examples demonstrate how to configure the authentication callbacks for different SASL mechanisms supported by EMQTT.
